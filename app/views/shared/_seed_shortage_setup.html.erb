<!-- ã‚¿ãƒä¸è¶³ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<%= render 'shared/seed_shortage_modal' %>

<script>
  function checkSeedCountBeforeAction(event, checkboxId = null) {
    console.log('ğŸŒ± checkSeedCountBeforeAction called', { event, checkboxId });
    const seedCount = <%= current_user.seed_count %>;
    const notesTextarea = document.querySelector('#diary_notes');
    const hasNotes = notesTextarea && notesTextarea.value.trim().length > 0;
    
    console.log('ğŸŒ± Seed count:', seedCount, 'Has notes:', hasNotes);
    
    // AIç”ŸæˆãŒå¿…è¦ã‹ã©ã†ã‹ã‚’åˆ¤å®š
    let needsAiGeneration = false;
    
    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼ˆç·¨é›†æ™‚ã¾ãŸã¯æ–°è¦ä½œæˆæ™‚ï¼‰
    if (checkboxId) {
      const checkbox = document.getElementById(checkboxId);
      console.log('ğŸŒ± Checkbox checked:', checkbox?.checked);
      needsAiGeneration = checkbox.checked && hasNotes;
    } else if (hasNotes) {
      // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒãªã„å ´åˆã§ãƒ¡ãƒ¢ãŒã‚ã‚‹å ´åˆã¯AIç”ŸæˆãŒå¿…è¦
      needsAiGeneration = true;
    }
    
    // ã‚¿ãƒä¸è¶³ãƒã‚§ãƒƒã‚¯
    if (needsAiGeneration && seedCount <= 0) {
      console.log('ğŸŒ± Seed shortage detected, preventing form submission');
      event.preventDefault();
      showSeedShortageModal();
      return false;
    }
    
    // AIç”ŸæˆãŒå¿…è¦ãªå ´åˆã¯å°‚ç”¨ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¡¨ç¤º
    if (needsAiGeneration) {
      console.log('ğŸ¤– AI generation needed, showing AI loading');
      if (window.aiLoadingController) {
        // é€šå¸¸ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éš ã—ã¦AIãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¡¨ç¤º
        if (window.loadingController) {
          window.loadingController.hide();
        }
        window.aiLoadingController.showDelayed();
      }
    } else {
      console.log('ğŸŒ± AI generation not needed, will show normal loading');
    }
    
    console.log('ğŸŒ± All checks passed, continuing with form submission');
    return true;
  }
</script>